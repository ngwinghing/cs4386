<!DOCTYPE html>
<head>
<script>
	//directions
	Up=1;
	Down=2;
	Front=3;

	function generateNewPolice(){
		this.PositionNum=Math.floor(Math.random()*10)+150;
		this.BombCount=2;
	}

	//move one grid
	function walk(direction){
		if (direction==Up)
			this.PositionNum--;
		else if (direction==Down)
			this.PositionNum++;
		else //Front
			this.PositionNum-=10;
		
		//check if fall into trap
		if (grids[this.PositionNum].occupant==="glue")
			setTimeout(encounterGlue(),1000);
		else if (grids[this.PostitionNum].occupant==="sewage")
			fallDownToSewageHole();
	}

	function attackOrWalk(){
		if (grids[this.PositionNum-10].occupant==="none")
			setTimeout(walk(Front),1000);
		//encounter obstacle
		else
		{
			//walk only if 1 grid upward or downward is available
			if (grids[this.PositionNum-10+1].occupant==="barrier" ||
				grids[this.PositionNum-10+1].occupant==="umbrella" ||
				grids[this.PositionNum-10-1].occupant==="barrier" ||
				grids[this.PositionNum-10-1].occupant==="umbrella")
				if (this.PositionNum%10>=5) {//more space downwards
					setTimeout(walk(Down),1000);
					setTimeout(walk(Front),1000);
				}
				else{
					setTimeout(walk(Up),1000);
					setTimeout(walk(Front),1000);
				}
			else
			{
				obstacleCount=0;
				for(i=0;i<10;i++)
					//retrieve front col from top to bottom
					if (grids[(Math.floor(this.Position/10)*10)+i].occupant==="barrier" ||
						grids[(Math.floor(this.Position/10)*10)+i].occupant==="umbrella") 
						obstacleCount++;
				//use bomb when there are more than 9 obstacle 
				if (obstacleCount>=9||this.BombCount>0)
					setTimeout(useBomb(),2000);
				//obstacleCount is 3 to 8
				else setTimeout(useRod(),1000); 
			}
		}
	}

	function useBomb(currentPos){
		for(i=0;i<2;i++){
			for(j=0;j<3;j++){
				if (grids[currentPos-10*(i+1)-1+j].occupant==="barrier" ||
					grids[currentPos-10*(i+1)-1+j].occupant==="umbrella")
					grids[currentPos-10*(i+1)-1+j].occupant="none";
			}
		}
		this.BombCount--;
		setTimeout(walk(Front),1000);
	}

	function useRod(currentPos){
		grids[currentPos-10].occupant="none";
		setTimeout(walk(Front),1000);
	}

	function encounterGlue(){
		setTimeout(attackOrWalk(), 3000);
	}

	function fallDownToSewageHole(){
		//code for delete image
		setTimeout(generateNewPolice(),1000);
	}
	
</script>
</head>

<h1></h1>
<div id='container' style='background-color:#004236'>

	<canvas id='game' width='680' height='650'>
	</canvas>
</div>
<script>
	init();
</script>
</html>








